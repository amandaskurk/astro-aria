---
import { getCollection } from "astro:content";

const allPosts = await getCollection("post");

// Type the props so Astro/TS stops complaining
type Props = {
  count?: number;
};

const { count = allPosts.length } = Astro.props as Props;

// Strongly type + guard against bad inputs
function parseDate(dateStr: string): Date {
  // Expected format: "Jan 02 2024" (month day year)
  const parts = dateStr.trim().split(/\s+/);
  if (parts.length < 3) return new Date(0);

  const [month, dayStr, yearStr] = parts;
  const day = Number.parseInt(dayStr, 10);
  const year = Number.parseInt(yearStr, 10);

  if (!Number.isFinite(day) || !Number.isFinite(year)) return new Date(0);

  return new Date(`${month} ${day}, ${year}`);
}

const sortedPosts = allPosts
  .map((post) => ({
    ...post,
    date: parseDate(String(post.data.dateFormatted ?? "")),
  }))
  .sort((a, b) => b.date.getTime() - a.date.getTime());

const postsLoop = sortedPosts.slice(0, count).map((post) => ({
  ...(post.data || {}),
  link: `/post/${post.slug}`,
}));
---
